name: Build & Release Multi-Platform

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created]

# 全局权限设置
permissions:
  contents: write
  packages: write
  actions: read # 需要读取 artifacts

jobs:
  # ================= 1. 构建阶段 (并行运行) =================

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Deps
        run: npm ci
      - name: Build
        run: |
          npm run build
          npx electron-builder --win --publish never
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: |
            dist/*-setup.exe
            dist/*-setup.exe.blockmap
            dist/latest.yml
          retention-days: 1 # 只需保留很短时间，发布完即自动清理

  build-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Deps
        run: npm ci
      - name: Build
        run: |
          npm run build
          npx electron-builder --linux --x64 --publish never
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-x64
          path: |
            dist/*.deb
            dist/*.AppImage
            dist/latest-linux.yml
          retention-days: 1

  build-linux-arm64:
    # 尝试使用原生 ARM runner，如果不可用请切换回 ubuntu-latest + QEMU
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Deps
        run: npm ci
      - name: Build
        run: |
          npm run build
          npx electron-builder --linux --arm64 --publish never
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-arm64
          path: |
            dist/*.deb
            dist/*.AppImage
          retention-days: 1

  # ================= 2. 发布阶段 (串行，依赖所有构建完成) =================

  publish-release:
    needs: [build-windows, build-linux-x64, build-linux-arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 下载所有构建产物
      - name: Download Windows Assets
        uses: actions/download-artifact@v4
        with:
          name: dist-windows
          path: dist-win

      - name: Download Linux x64 Assets
        uses: actions/download-artifact@v4
        with:
          name: dist-linux-x64
          path: dist-linux-x64

      - name: Download Linux ARM64 Assets
        uses: actions/download-artifact@v4
        with:
          name: dist-linux-arm64
          path: dist-linux-arm64

      # 合并文件到一个目录，方便 action-gh-release 处理
      - name: Merge Assets
        run: |
          mkdir -p dist-final
          cp dist-win/* dist-final/
          cp dist-linux-x64/* dist-final/
          cp dist-linux-arm64/* dist-final/

          # 可选：打印文件列表确认
          ls -R dist-final/

      # 统一上传并发布
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist-final/*
