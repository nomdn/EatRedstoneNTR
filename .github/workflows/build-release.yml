name: Build & Release Multi-Platform

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created]

# å…¨å±€æƒé™è®¾ç½®
permissions:
  contents: write
  packages: write
  actions: read # éœ€è¦è¯»å– artifacts

jobs:
  # ================= 1. æ„å»ºé˜¶æ®µ (å¹¶è¡Œè¿è¡Œ) =================

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Deps
        run: npm ci
      - name: Build
        run: |
          npm run build
          npx electron-builder --win --publish never
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: |
            dist/*-setup.exe
            dist/*-setup.exe.blockmap
            dist/latest.yml
          retention-days: 1 # åªéœ€ä¿ç•™å¾ˆçŸ­æ—¶é—´ï¼Œå‘å¸ƒå®Œå³è‡ªåŠ¨æ¸…ç†

  build-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Deps
        run: npm ci
      - name: Build
        run: |
          npm run build
          npx electron-builder --linux --x64 --publish never
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-x64
          path: |
            dist/*.deb
            dist/*.AppImage
            dist/latest-linux.yml
          retention-days: 1

  build-linux-arm64:
    # å°è¯•ä½¿ç”¨åŸç”Ÿ ARM runnerï¼Œå¦‚æœä¸å¯ç”¨è¯·åˆ‡æ¢å› ubuntu-latest + QEMU
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Deps
        run: npm ci
      - name: Build
        run: |
          npm run build
          npx electron-builder --linux --arm64 --publish never
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-arm64
          path: |
            dist/*.deb
            dist/*.AppImage
          retention-days: 1

  # ================= 2. å‘å¸ƒé˜¶æ®µ (ä¸²è¡Œï¼Œä¾èµ–æ‰€æœ‰æ„å»ºå®Œæˆ) =================

  publish-release:
    needs: [build-windows, build-linux-x64, build-linux-arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: Download Windows Assets
        uses: actions/download-artifact@v4
        with:
          name: dist-windows
          path: dist-win

      - name: Download Linux x64 Assets
        uses: actions/download-artifact@v4
        with:
          name: dist-linux-x64
          path: dist-linux-x64

      - name: Download Linux ARM64 Assets
        uses: actions/download-artifact@v4
        with:
          name: dist-linux-arm64
          path: dist-linux-arm64

      # åˆå¹¶æ–‡ä»¶åˆ°ä¸€ä¸ªç›®å½•ï¼Œæ–¹ä¾¿ action-gh-release å¤„ç†
      - name: Merge Assets
        run: |
          mkdir -p dist-final
          cp dist-win/* dist-final/
          cp dist-linux-x64/* dist-final/
          cp dist-linux-arm64/* dist-final/

          # å¯é€‰ï¼šæ‰“å°æ–‡ä»¶åˆ—è¡¨ç¡®è®¤
          ls -R dist-final/

      # ç»Ÿä¸€ä¸Šä¼ å¹¶å‘å¸ƒ
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body: |
            ## ğŸ“¦ æ›´æ–°æ—¥å¿—

            æœ¬æ¬¡å‘å¸ƒåŒ…å«ä»¥ä¸‹å¹³å°çš„å®‰è£…åŒ…ï¼š

            | ç³»ç»Ÿ | æ¶æ„ | æ¨èæ–‡ä»¶ | å¤‡æ³¨ |
            | :--- | :--- | :--- | :--- |
            | **Windows** | x64 | `*-setup.exe` | ä¸€é”®å®‰è£… |
            | **Linux** | x64 | `*-x64.AppImage` / `*.deb` | Ubuntu/Debian/CentOS |
            | **Linux** | ARM64 | `*-arm64.AppImage` / `*-arm64.deb` | æ ‘è“æ´¾/åä¸º/Oracle Pi |

            > ğŸ’¡ **æç¤º**: å¦‚æœä¸ç¡®å®šæ¶æ„ï¼ŒLinux ç”¨æˆ·é€šå¸¸é€‰æ‹© `.deb` (Debian/Ubuntu) æˆ– `AppImage` (é€šç”¨)ã€‚
          generate_release_notes: true
          files: |
            dist-final/*
