name: Build & Release Multi-Platform

on:
  push:
    tags:
      - 'v*'
  release:
    types: [created]

# å…¨å±€æƒé™è®¾ç½®
permissions:
  contents: write
  packages: write
  actions: read # éœ€è¦è¯»å– artifacts

jobs:
  # ================= 1. æ„å»ºé˜¶æ®µ (å¹¶è¡Œè¿è¡Œ) =================

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Deps
        run: npm ci
      - name: Build
        run: |
          npm run build
          npx electron-builder --win --publish never
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: |
            dist/*-setup.exe
            dist/*-setup.exe.blockmap
            dist/latest.yml
          retention-days: 1 # åªéœ€ä¿ç•™å¾ˆçŸ­æ—¶é—´ï¼Œå‘å¸ƒå®Œå³è‡ªåŠ¨æ¸…ç†

  build-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Deps
        run: npm ci
      - name: Build
        run: |
          npm run build
          npx electron-builder --linux --x64 --publish never
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-x64
          path: |
            dist/*.deb
            dist/*.AppImage
            dist/latest-linux.yml
          retention-days: 1

  build-linux-arm64:
    # å°è¯•ä½¿ç”¨åŸç”Ÿ ARM runnerï¼Œå¦‚æœä¸å¯ç”¨è¯·åˆ‡æ¢å› ubuntu-latest + QEMU
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install Deps
        run: npm ci
      - name: Build
        run: |
          npm run build
          npx electron-builder --linux --arm64 --publish never
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-arm64
          path: |
            dist/*.deb
            dist/*.AppImage
          retention-days: 1

  # ================= 2. å‘å¸ƒé˜¶æ®µ (ä¸²è¡Œï¼Œä¾èµ–æ‰€æœ‰æ„å»ºå®Œæˆ) =================

  publish-release:
    needs: [build-windows, build-linux-x64, build-linux-arm64]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: Download Windows Assets
        uses: actions/download-artifact@v4
        with:
          name: dist-windows
          path: dist-win

      - name: Download Linux x64 Assets
        uses: actions/download-artifact@v4
        with:
          name: dist-linux-x64
          path: dist-linux-x64

      - name: Download Linux ARM64 Assets
        uses: actions/download-artifact@v4
        with:
          name: dist-linux-arm64
          path: dist-linux-arm64

      # åˆå¹¶æ–‡ä»¶åˆ°ä¸€ä¸ªç›®å½•ï¼Œæ–¹ä¾¿ action-gh-release å¤„ç†
      - name: Merge Assets
        run: |
          mkdir -p dist-final
          cp dist-win/* dist-final/
          cp dist-linux-x64/* dist-final/
          cp dist-linux-arm64/* dist-final/

          # å¯é€‰ï¼šæ‰“å°æ–‡ä»¶åˆ—è¡¨ç¡®è®¤
          ls -R dist-final/

      # ç»Ÿä¸€ä¸Šä¼ å¹¶å‘å¸ƒ
# --- è·å– Commit ä¿¡æ¯ (æ ¸å¿ƒä¿®æ”¹) ---
      - name: Get Commit Info
        id: commit_info
        run: |
          COMMIT_SHORT_SHA=$(git rev-parse --short HEAD)
          COMMIT_SUBJECT=$(git log -1 --pretty=format:"%s")

          echo "short_sha=$COMMIT_SHORT_SHA" >> $GITHUB_OUTPUT
          echo "subject=$COMMIT_SUBJECT" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Tag: ${{ github.ref_name }}"
          echo "ğŸ’¬ Commit: $COMMIT_SUBJECT ($COMMIT_SHORT_SHA)"

      # --- ç”Ÿæˆä¸“ä¸šçš„ Release Body ---
      - name: Generate Release Body
        id: changelog
        run: |
          cat << EOF > body.md
          ## ğŸš€ ç‰ˆæœ¬å‘å¸ƒï¼š${{ github.ref_name }}

          **æ›´æ–°å†…å®¹**: ${{ steps.commit_info.outputs.subject }}
          **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M UTC")

          ---
          ### ğŸ“¦ ä¸‹è½½åˆ—è¡¨

          | å¹³å° | æ¶æ„ | æ¨èæ–‡ä»¶ | è¯´æ˜ |
          | :--- | :--- | :--- | :--- |
          | **Windows** | x64 | \`win/*-setup.exe\` | ä¸€é”®å®‰è£…ç¨‹åº |
          | **Linux** | x64 | \`linux-x64/*-x64.AppImage\` | é€šç”¨å…å®‰è£… (æ¨è) |
          | **Linux** | x64 | \`linux-x64/*.deb\` | Debian/Ubuntu å®‰è£…åŒ… |
          | **Linux** | ARM64 | \`linux-arm64/*-arm64.AppImage\` | æ ‘è“æ´¾/åä¸º/Oracle Pi |
          | **Linux** | ARM64 | \`linux-arm64/*-arm64.deb\` | ARM æ¶æ„ Deb åŒ… |

          > ğŸ’¡ **æç¤º**:
          > - Windows ç”¨æˆ·ç›´æ¥è¿è¡Œ \`setup.exe\`ã€‚
          > - Linux ç”¨æˆ·ä¼˜å…ˆé€‰æ‹© \`AppImage\`ï¼Œæ— éœ€å®‰è£…ï¼Œèµ‹äºˆæ‰§è¡Œæƒé™ååŒå‡»å³å¯è¿è¡Œã€‚
          > - å¦‚æœä¸ç¡®å®šæ¶æ„ï¼Œè¯·åœ¨ç»ˆç«¯è¿è¡Œ \`uname -m\` (x86_64 ä¸º x64, aarch64 ä¸º ARM64)ã€‚
          EOF

          echo "body<<EOFMARKER" >> $GITHUB_OUTPUT
          cat body.md >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      # --- ç»Ÿä¸€ä¸Šä¼ å¹¶å‘å¸ƒ ---
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # âœ… å…³é”®ï¼šä½¿ç”¨ Git Tag (å¦‚ v1.1.0) è€Œä¸æ˜¯ Hash
          tag_name: ${{ github.ref_name }}

          # âœ… æ ‡é¢˜æ ¼å¼ï¼šæäº¤æ ‡é¢˜ (ç‰ˆæœ¬å·)
          name: "${{ steps.commit_info.outputs.subject }} (${{ github.ref_name }})"

          # âœ… ä½¿ç”¨ç”Ÿæˆçš„è¯¦ç»†æ­£æ–‡
          body: ${{ steps.changelog.outputs.body }}

          generate_release_notes: true # è‡ªåŠ¨è¿½åŠ  GitHub çš„å˜æ›´æ—¥å¿—
          draft: false
          prerelease: false

          # ä¸Šä¼ æ‰€æœ‰æ•´ç†å¥½çš„æ–‡ä»¶ (åŒ…å«å­ç›®å½•ç»“æ„)
          files: |
            dist-final/**/*
